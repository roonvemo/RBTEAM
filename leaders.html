<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù‚Ø§Ø¹Ø© Ø§Ù„Ù‚Ø§Ø¯Ø© | Leaders Chat</title>
  <style>
    :root { --primary: #16d1cc; --orange: #ff9800; --white:#fff; }
    body { margin:0; font-family:'Tajawal',sans-serif;
      background: linear-gradient(145deg,#0b1416,#112f2e);
      min-height:100vh; display:flex; flex-direction:column; color:var(--white); }
    .chat-header{ text-align:center; padding:15px 0; font-size:22px; font-weight:bold;
      background:rgba(255,255,255,0.05); backdrop-filter:blur(10px); border-bottom:1px solid rgba(255,255,255,0.1);}
    .chat-box{ flex:1; padding:15px; overflow-y:auto; display:flex; flex-direction:column; gap:10px; }
    .message{ max-width:75%; padding:10px 14px; border-radius:18px; backdrop-filter:blur(8px);
      background:rgba(255,255,255,0.1); box-shadow:0 2px 10px rgba(0,0,0,0.2); word-wrap:break-word; }
    .message.me{ align-self:flex-end; background: linear-gradient(135deg,var(--primary),var(--orange)); color:#fff; }
    .message .sender{ font-weight:bold; font-size:14px; opacity:0.9; margin-bottom:4px; }
    img,video,iframe { max-width:100%; border-radius:12px; margin-top:8px; }
    iframe { aspect-ratio:16/9; border:none; }
    .chat-input{ display:flex; align-items:center; gap:8px; padding:12px;
      background:rgba(255,255,255,0.05); backdrop-filter:blur(10px); border-top:1px solid rgba(255,255,255,0.1); position:relative; }
    .chat-input input[type="text"]{ flex:1; padding:10px 14px; border-radius:25px; border:none;
      background:rgba(255,255,255,0.12); color:white; outline:none; font-size:15px; }
    .chat-input button{ background:var(--orange); border:none; border-radius:50%; width:44px; height:44px;
      cursor:pointer; display:flex; align-items:center; justify-content:center; box-shadow:0 0 10px rgba(0,0,0,0.3); transition:transform .2s; font-size:18px; }
    .chat-input button:hover{ transform:scale(1.1); }
    .emoji-picker{ position:absolute; bottom:70px; right:50px; background:rgba(20,20,20,0.95);
      backdrop-filter:blur(12px); border-radius:15px; padding:10px; display:grid; grid-template-columns:repeat(8,1fr);
      gap:5px; max-height:220px; overflow-y:auto; box-shadow:0 4px 20px rgba(0,0,0,0.3); z-index:100; }
    .emoji-picker span{ font-size:22px; cursor:pointer; padding:4px; border-radius:8px; text-align:center; }
    .emoji-picker span:hover{ background:rgba(255,255,255,0.1); transform:scale(1.2); }
    .bottom-bar{ display:flex; justify-content:space-around; align-items:center; padding:10px;
      background:rgba(255,255,255,0.07); backdrop-filter:blur(12px); border-top:1px solid rgba(255,255,255,0.1); position:sticky; bottom:0; }
    .bottom-bar img{ width:28px; height:28px; cursor:pointer; transition:transform .2s; }
    .recording{ animation:pulse 1s infinite; background:red !important; }
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(255,0,0,0.6);}70%{box-shadow:0 0 0 12px rgba(255,0,0,0);}100%{box-shadow:0 0 0 0 rgba(255,0,0,0);} }
  </style>
</head>
<body>

  <div class="chat-header">ğŸ† Ù‚Ø§Ø¹Ø© Ø§Ù„Ù‚Ø§Ø¯Ø©</div>

  <div class="chat-box" id="chatBox">
    <div class="message">
      <div class="sender">Ù…Ø±Ø­Ø¨Ø§Ù‹</div>
      Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙƒÙ… ÙÙŠ Ù‚Ø§Ø¹Ø© Ø§Ù„Ù‚Ø§Ø¯Ø© ğŸ’ª
    </div>
  </div>

  <div class="chat-input">
    <button onclick="document.getElementById('fileInput').click()">ğŸ“</button>
    <input type="file" id="fileInput" accept="image/*,video/*" style="display:none" onchange="sendMedia(this)" />
    <input type="text" id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." />
    <button id="emojiBtn">ğŸ˜„</button>
    <button id="recordBtn" onclick="toggleRecording()">ğŸ¤</button>
    <button onclick="sendMessage()">â¤</button>

    <div id="emojiPicker" class="emoji-picker" style="display:none;"></div>
  </div>

  <div class="bottom-bar">
    <img src="assets/icons/home.png" alt="home" onclick="goToHome()">
    <img src="assets/icons/chat.png" alt="chatrooms" onclick="goToChatrooms()">
  </div>

<script>
  const userName = localStorage.getItem("name") || "Ø£Ù†Ø§";
  let mediaRecorder, audioChunks = [], isRecording = false;

  // emoji list
  const emojis = ["ğŸ˜€","ğŸ˜","ğŸ˜‚","ğŸ¤£","ğŸ˜ƒ","ğŸ˜„","ğŸ˜…","ğŸ˜†","ğŸ˜‰","ğŸ˜Š","ğŸ˜","ğŸ˜˜","ğŸ˜","ğŸ¤©","ğŸ¥³",
    "ğŸ˜‡","ğŸ˜‹","ğŸ˜œ","ğŸ¤ª","ğŸ¤“","ğŸ˜","ğŸ˜¢","ğŸ˜­","ğŸ˜¡","ğŸ¤¬","ğŸ˜±","ğŸ˜³","ğŸ˜´","ğŸ¤¤","ğŸ˜ª","ğŸ˜·",
    "ğŸ¤’","ğŸ¤•","ğŸ¤¢","ğŸ¤®","ğŸ¥¶","ğŸ¥µ","ğŸ¥°","ğŸ¤”","ğŸ¤«","ğŸ¤­","ğŸ¤—","ğŸ˜¬","ğŸ™„","ğŸ¤·â€â™‚ï¸","ğŸ¤·â€â™€ï¸","ğŸ’ª","ğŸ‘",
    "ğŸ‘","ğŸ‘","ğŸ™","ğŸ”¥","ğŸ’¯","ğŸ¯","ğŸ‰","â¤ï¸","ğŸ’”","ğŸ’‹","ğŸ’¼","ğŸ“ˆ","ğŸ’°","ğŸš€","ğŸŒŸ"];
  const picker = document.getElementById("emojiPicker");
  emojis.forEach(e => { const s=document.createElement("span"); s.textContent=e; s.onclick=()=>insertEmoji(e); picker.appendChild(s); });

  document.getElementById("emojiBtn").onclick = (ev) => { ev.stopPropagation(); picker.style.display = picker.style.display === "none" ? "grid" : "none"; };
  document.addEventListener("click", (e) => { if (!e.target.closest("#emojiPicker") && !e.target.closest("#emojiBtn")) picker.style.display = "none"; });

  function insertEmoji(emoji){ const input=document.getElementById("messageInput"); input.value += emoji; input.focus(); }

  // robust extraction of YouTube ID
  function extractYouTubeID(urlOrText) {
    if (!urlOrText) return null;
    const urlRegex = /(https?:\/\/[^\s]+)/g;
    const parts = urlOrText.match(urlRegex) || [urlOrText];
    for (const part of parts) {
      let m = part.match(/[?&]v=([A-Za-z0-9_-]{11})/);
      if (m && m[1]) return m[1];
      m = part.match(/youtu\.be\/([A-Za-z0-9_-]{11})/);
      if (m && m[1]) return m[1];
      m = part.match(/\/embed\/([A-Za-z0-9_-]{11})/);
      if (m && m[1]) return m[1];
      m = part.match(/\/shorts\/([A-Za-z0-9_-]{11})/);
      if (m && m[1]) return m[1];
      m = part.match(/([A-Za-z0-9_-]{11})/);
      if (m && m[1]) {
        if (/youtube|youtu\.be|watch|shorts|embed/.test(part)) return m[1];
      }
    }
    return null;
  }

  // send message with YouTube handling & fallback link
  function sendMessage() {
    const input = document.getElementById("messageInput");
    const text = input.value.trim();
    if (!text) return;
    const box = document.getElementById("chatBox");

    const msg = document.createElement("div");
    msg.className = "message me";

    const sender = document.createElement("div");
    sender.className = "sender";
    sender.textContent = userName;
    msg.appendChild(sender);

    const vid = extractYouTubeID(text);
    if (vid) {
      console.log("YouTube id extracted:", vid);
      const iframe = document.createElement("iframe");
      iframe.src = `https://www.youtube.com/embed/${vid}`;
      iframe.width = "100%";
      iframe.height = "200";
      iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
      iframe.allowFullscreen = true;
      msg.appendChild(iframe);
    } else {
      const urlRegex = /(https?:\/\/[^\s]+)/g;
      const replaced = text.replace(urlRegex, (url) => {
        return `<a href="${url}" target="_blank" rel="noopener noreferrer" style="color:inherit; text-decoration:underline;">${url}</a>`;
      });
      const wrapper = document.createElement("div");
      wrapper.innerHTML = replaced;
      msg.appendChild(wrapper);
    }

    box.appendChild(msg);
    box.scrollTop = box.scrollHeight;
    input.value = "";
  }

  // send media (image/video)
  function sendMedia(input) {
    const file = input.files[0];
    if (!file) return;
    const box = document.getElementById("chatBox");
    const msg = document.createElement("div");
    msg.className = "message me";
    const sender = document.createElement("div");
    sender.className = "sender";
    sender.textContent = userName;
    msg.appendChild(sender);
    if (file.type.startsWith("image/")) {
      const img = document.createElement("img"); img.src = URL.createObjectURL(file); msg.appendChild(img);
    } else if (file.type.startsWith("video/")) {
      const video = document.createElement("video"); video.src = URL.createObjectURL(file); video.controls = true; msg.appendChild(video);
    }
    box.appendChild(msg); box.scrollTop = box.scrollHeight; input.value = "";
  }

  // audio recording
  async function toggleRecording() {
    const recordBtn = document.getElementById("recordBtn");
    if (!isRecording) {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        mediaRecorder.ondataavailable = e => { if (e.data && e.data.size) audioChunks.push(e.data); };
        mediaRecorder.onstop = sendAudio;
        mediaRecorder.start();
        isRecording = true; recordBtn.classList.add("recording");
      } catch (err) { alert("âš ï¸ Ù„Ù… ÙŠØªÙ… Ù…Ù†Ø­ Ø¥Ø°Ù† Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†"); console.error(err); }
    } else {
      mediaRecorder.stop(); isRecording = false; recordBtn.classList.remove("recording");
    }
  }

  function sendAudio() {
    const blob = new Blob(audioChunks, { type:'audio/ogg; codecs=opus' });
    const url = URL.createObjectURL(blob);
    const box = document.getElementById("chatBox");
    const msg = document.createElement("div"); msg.className="message me";
    const sender = document.createElement("div"); sender.className="sender"; sender.textContent=userName; msg.appendChild(sender);
    const audio = document.createElement("audio"); audio.controls = true; audio.src = url; msg.appendChild(audio);
    box.appendChild(msg); box.scrollTop = box.scrollHeight;
  }

  // navigation
  function goToHome(){ window.location.href = "index.html"; }
  function goToChatrooms(){ window.location.href = "chatrooms.html"; }

  // init: populate emoji picker (already built above)
  (function initPicker(){})();
</script>

</body>
</html>
