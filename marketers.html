<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ğŸ’¼ Ù‚Ø§Ø¹Ø© Ø§Ù„Ù…Ø³ÙˆÙ‚ÙŠÙ† | Marketers Chat</title>
<style>
:root { --primary: #16d1cc; --orange: #ff9800; --white:#fff; }
body { margin:0; font-family:'Tajawal',sans-serif; background: linear-gradient(145deg,#0b1416,#112f2e); min-height:100vh; display:flex; flex-direction:column; color:var(--white);}
.chat-header{ text-align:center; padding:15px 0; font-size:22px; font-weight:bold; background:rgba(255,255,255,0.05); backdrop-filter:blur(10px); border-bottom:1px solid rgba(255,255,255,0.1);}
.chat-box{ flex:1; padding:15px; overflow-y:auto; display:flex; flex-direction:column; gap:10px; }
.message{ max-width:75%; padding:10px 14px; border-radius:18px; backdrop-filter:blur(8px); background:rgba(255,255,255,0.1); box-shadow:0 2px 10px rgba(0,0,0,0.2); word-wrap:break-word; display:flex; gap:10px; align-items:flex-start; position:relative; cursor:pointer;}
.message.me{ align-self:flex-end; background: linear-gradient(135deg,var(--primary),var(--orange)); color:#fff; }
.message img.profile{ width:35px; height:35px; border-radius:50%; object-fit:cover; }
.message .sender{ font-weight:bold; font-size:14px; opacity:0.9; margin-bottom:4px; }
.message .time{ font-size:11px; opacity:0.7; margin-top:3px; text-align:right; }
img,video,iframe { max-width:100%; border-radius:12px; margin-top:8px; }
iframe { aspect-ratio:16/9; border:none; }
.chat-input{ display:flex; align-items:center; gap:8px; padding:12px; background:rgba(255,255,255,0.05); backdrop-filter:blur(10px); border-top:1px solid rgba(255,255,255,0.1); position:relative; }
.chat-input input[type="text"]{ flex:1; padding:10px 14px; border-radius:25px; border:none; background:rgba(255,255,255,0.12); color:white; outline:none; font-size:15px; }
.chat-input button{ background:var(--orange); border:none; border-radius:50%; width:44px; height:44px; cursor:pointer; display:flex; align-items:center; justify-content:center; box-shadow:0 0 10px rgba(0,0,0,0.3); transition:transform .2s; font-size:18px; }
.chat-input button:hover{ transform:scale(1.1); }
.emoji-picker{ position:absolute; bottom:70px; right:50px; background:rgba(20,20,20,0.95); backdrop-filter:blur(12px); border-radius:15px; padding:10px; display:grid; grid-template-columns:repeat(8,1fr); gap:5px; max-height:220px; overflow-y:auto; box-shadow:0 4px 20px rgba(0,0,0,0.3); z-index:100; display:none; }
.emoji-picker span{ font-size:22px; cursor:pointer; padding:4px; border-radius:8px; text-align:center; }
.emoji-picker span:hover{ background:rgba(255,255,255,0.1); transform:scale(1.2); }
.bottom-bar{ display:flex; justify-content:space-around; align-items:center; padding:10px; background:rgba(255,255,255,0.07); backdrop-filter:blur(12px); border-top:1px solid rgba(255,255,255,0.1); position:sticky; bottom:0; }
.bottom-bar img{ width:28px; height:28px; cursor:pointer; transition:transform .2s; }
.recording{ animation:pulse 1s infinite; background:red !important; }
@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(255,0,0,0.6);}70%{box-shadow:0 0 0 12px rgba(255,0,0,0);}100%{box-shadow:0 0 0 0 rgba(255,0,0,0);}}
.typing-indicator{ font-size:12px; opacity:0.6; margin:5px;}
</style>
</head>
<body>

<div class="chat-header">ğŸ’¼ Ù‚Ø§Ø¹Ø© Ø§Ù„Ù…Ø³ÙˆÙ‚ÙŠÙ†</div>
<div class="chat-box" id="chatBox"></div>
<div class="typing-indicator" id="typingIndicator" style="display:none;">ÙŠÙƒØªØ¨...</div>

<div class="chat-input">
  <button onclick="document.getElementById('fileInput').click()">ğŸ“</button>
  <input type="file" id="fileInput" accept="image/*,video/*" style="display:none" onchange="sendMedia(this)" />
  <input type="text" id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." oninput="showTyping()"/>
  <button id="emojiBtn">ğŸ˜„</button>
  <button id="recordBtn" onclick="toggleRecording()">ğŸ¤</button>
  <button onclick="sendMessage()">â¤</button>
  <div id="emojiPicker" class="emoji-picker"></div>
</div>

<div class="bottom-bar">
  <img src="assets/icons/home.png" alt="home" onclick="goToHome()">
  <img src="assets/icons/chat.png" alt="chatrooms" onclick="goToChatrooms()">
</div>

<script>
const chatBox = document.getElementById("chatBox");
const userName = localStorage.getItem("name") || "Ø£Ù†Ø§";
const userProfile = localStorage.getItem("profile") || "assets/icons/user.png";
let mediaRecorder, audioChunks = [], isRecording = false;

// Load messages from localStorage
function loadMessages(){
  const saved = JSON.parse(localStorage.getItem("chatMessages")||"[]");
  saved.forEach(m => appendMessage(m.sender,m.content,m.type,m.time,m.profile,false));
}
loadMessages();

// Typing indicator
let typingTimeout;
function showTyping(){
  const indicator = document.getElementById("typingIndicator");
  indicator.style.display = "block";
  clearTimeout(typingTimeout);
  typingTimeout = setTimeout(()=>{indicator.style.display="none";},1000);
}

// Emoji picker
const emojis = ["ğŸ˜€","ğŸ˜","ğŸ˜‚","ğŸ¤£","ğŸ˜ƒ","ğŸ˜„","ğŸ˜…","ğŸ˜†","ğŸ˜‰","ğŸ˜Š","ğŸ˜","ğŸ˜˜","ğŸ˜","ğŸ¤©","ğŸ¥³","ğŸ˜‡","ğŸ˜‹","ğŸ˜œ","ğŸ¤ª","ğŸ¤“","ğŸ˜","ğŸ˜¢","ğŸ˜­","ğŸ˜¡","ğŸ¤¬","ğŸ˜±","ğŸ˜³","ğŸ˜´","ğŸ¤¤","ğŸ˜ª","ğŸ˜·","ğŸ¤’","ğŸ¤•","ğŸ¤¢","ğŸ¤®","ğŸ¥¶","ğŸ¥µ","ğŸ¥°","ğŸ¤”","ğŸ¤«","ğŸ¤­","ğŸ¤—","ğŸ˜¬","ğŸ™„","ğŸ¤·â€â™‚ï¸","ğŸ¤·â€â™€ï¸","ğŸ’ª","ğŸ‘","ğŸ‘","ğŸ‘","ğŸ™","ğŸ”¥","ğŸ’¯","ğŸ¯","ğŸ‰","â¤ï¸","ğŸ’”","ğŸ’‹","ğŸ’¼","ğŸ“ˆ","ğŸ’°","ğŸš€","ğŸŒŸ"];
const picker = document.getElementById("emojiPicker");
emojis.forEach(e=>{let s=document.createElement("span");s.textContent=e;s.onclick=()=>insertEmoji(e);picker.appendChild(s);});
document.getElementById("emojiBtn").onclick=(ev)=>{ev.stopPropagation();picker.style.display=picker.style.display==="none"?"grid":"none";};
document.addEventListener("click",e=>{if(!e.target.closest("#emojiPicker")&&!e.target.closest("#emojiBtn"))picker.style.display="none";});
function insertEmoji(e){document.getElementById("messageInput").value+=e;}

// Save messages
function saveMessages(){
  const messages = Array.from(chatBox.children).map(msg=>{
    return {
      sender: msg.querySelector('.sender').textContent,
      content: msg.dataset.content,
      type: msg.dataset.type,
      time: msg.dataset.time,
      profile: msg.querySelector('img.profile').src
    };
  });
  localStorage.setItem("chatMessages",JSON.stringify(messages));
}

// Append message function
function appendMessage(sender, content, type="text", time=null, profile=userProfile, save=true){
  if(!time) time=new Date().toLocaleTimeString();
  const msg=document.createElement("div");
  msg.className="message me";
  msg.dataset.content=content;
  msg.dataset.type=type;
  msg.dataset.time=time;
  msg.onclick=()=>{msg.remove(); saveMessages();};

  const imgProfile=document.createElement("img"); imgProfile.src=profile; imgProfile.className="profile"; msg.appendChild(imgProfile);

  const wrapper=document.createElement("div");
  const senderEl=document.createElement("div"); senderEl.className="sender"; senderEl.textContent=sender; wrapper.appendChild(senderEl);

  if(type==="youtube"){
    const iframe=document.createElement("iframe"); iframe.src=`https://www.youtube.com/embed/${content}`; iframe.allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"; iframe.allowFullscreen=true; wrapper.appendChild(iframe);
  } else if(type==="image"){
    const img=document.createElement("img"); img.src=content; wrapper.appendChild(img);
  } else if(type==="video"){
    const vid=document.createElement("video"); vid.src=content; vid.controls=true; wrapper.appendChild(vid);
  } else {
    const div=document.createElement("div");
    const urlRegex=/(https?:\/\/[^\s]+)/g;
    const replaced=content.replace(urlRegex,url=>`<a href="${url}" target="_blank" style="color:inherit;text-decoration:underline;">${url}</a>`);
    div.innerHTML=replaced; wrapper.appendChild(div);
  }

  const timeEl=document.createElement("div"); timeEl.className="time"; timeEl.textContent=time; wrapper.appendChild(timeEl);

  msg.appendChild(wrapper);
  chatBox.appendChild(msg);
  chatBox.scrollTop=chatBox.scrollHeight;
  if(save) saveMessages();
}

// Send message
function sendMessage(){
  const input=document.getElementById("messageInput");
  const text=input.value.trim();
  if(!text) return;
  const youtubeID=extractYouTubeID(text);
  if(youtubeID) appendMessage(userName,youtubeID,"youtube");
  else appendMessage(userName,text,"text");
  input.value="";
}

// Extract YouTube ID
function extractYouTubeID(url){
  if(!url) return null;
  const m1=url.match(/[?&]v=([A-Za-z0-9_-]{11})/);
  if(m1&&m1[1]) return m1[1];
  const m2=url.match(/youtu\.be\/([A-Za-z0-9_-]{11})/);
  if(m2&&m2[1]) return m2[1];
  const m3=url.match(/\/embed\/([A-Za-z0-9_-]{11})/);
  if(m3&&m3[1]) return m3[1];
  const m4=url.match(/\/shorts\/([A-Za-z0-9_-]{11})/);
  if(m4&&m4[1]) return m4[1];
  return null;
}

// Send media
function sendMedia(input){
  const file=input.files[0];
  if(!file) return;
  let type="image";
  if(file.type.startsWith("video/")) type="video";
  const url=URL.createObjectURL(file);
  appendMessage(userName,url,type);
  input.value="";
}

// Audio recording
async function toggleRecording(){
  const btn=document.getElementById("recordBtn");
  if(!isRecording){
    try{
      const stream=await navigator.mediaDevices.getUserMedia({audio:true});
      mediaRecorder=new MediaRecorder(stream);
      audioChunks=[];
      mediaRecorder.ondataavailable=e=>{if(e.data.size) audioChunks.push(e.data);}
      mediaRecorder.onstop=sendAudio;
      mediaRecorder.start();
      isRecording=true; btn.classList.add("recording");
    }catch(e){alert("âš ï¸ Ù„Ù… ÙŠØªÙ… Ù…Ù†Ø­ Ø¥Ø°Ù† Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†");}
  } else {mediaRecorder.stop(); isRecording=false; btn.classList.remove("recording");}
}
function sendAudio(){
  const blob=new Blob(audioChunks,{type:'audio/ogg; codecs=opus'});
  const url=URL.createObjectURL(blob);
  appendMessage(userName,url,"video"); // ØµÙˆØª ÙƒÙ…Ù„Ù ØµÙˆØªÙŠ (Ø£Ùˆ video tag ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ±Ù‡)
}

// Navigation
function goToHome(){window.location.href="index.html";}
function goToChatrooms(){window.location.href="chatrooms.html";}
</script>

</body>
</html>
